use crate::Matrix3x3;
use std::{
    marker::Destruct,
    ops::{Add, Mul, MulAssign},
};

impl<T: [const] Add<Output = T> + [const] Mul<Output = T> + [const] Clone + [const] Destruct> const
    Mul for Matrix3x3<T>
{
    type Output = Matrix3x3<T>;

    fn mul(self, rhs: Self) -> Self::Output {
        Matrix3x3::new_rows(
            self.r0 * rhs.clone(),
            self.r1 * rhs.clone(),
            self.r2 * rhs.clone(),
        )
    }
}

impl<T: [const] Add<Output = T> + [const] Mul<Output = T> + [const] Clone + [const] Destruct> const
    MulAssign for Matrix3x3<T>
{
    fn mul_assign(&mut self, rhs: Self) {
        *self = self.clone() * rhs;
    }
}

#[cfg(test)]
mod tests {
    use crate::Matrix3x3f;

    macro_rules! matrix_mul_tests {
        [$(
            $test_name: ident: ($i1: expr, $i2: expr) -> $o: expr,
        )*] => {$(
            #[test]
            fn $test_name() {
                const INPUT1: Matrix3x3f = Matrix3x3f::from_row_array($i1);
                const INPUT2: Matrix3x3f = Matrix3x3f::from_row_array($i2);
                const OUTPUT: Matrix3x3f = Matrix3x3f::from_row_array($o);

                let output = INPUT1 * INPUT2;

                assert!(output.approx_eq(OUTPUT, 1e-6), "matrix multiply failed: {} vs. {}", output, OUTPUT);
            }
        )*};
    }

    matrix_mul_tests![
        matrix_mul_identity_left: ([[1.0, 0.0, 0.0],
                                   [0.0, 1.0, 0.0],
                                   [0.0, 0.0, 1.0]],
                                  [[2.0, -3.0, 4.0],
                                   [5.0, 6.0, -7.0],
                                   [8.0, 9.0, 10.0]]) -> [[2.0, -3.0, 4.0],
                                                           [5.0, 6.0, -7.0],
                                                           [8.0, 9.0, 10.0]],

        matrix_mul_identity_right: ([[2.0, -3.0, 4.0],
                                    [5.0, 6.0, -7.0],
                                    [8.0, 9.0, 10.0]],
                                   [[1.0, 0.0, 0.0],
                                    [0.0, 1.0, 0.0],
                                    [0.0, 0.0, 1.0]]) -> [[2.0, -3.0, 4.0],
                                                           [5.0, 6.0, -7.0],
                                                           [8.0, 9.0, 10.0]],

        matrix_mul_zero_left: ([[0.0, 0.0, 0.0],
                                [0.0, 0.0, 0.0],
                                [0.0, 0.0, 0.0]],
                               [[1.0, 2.0, 3.0],
                                [4.0, 5.0, 6.0],
                                [7.0, 8.0, 9.0]]) -> [[0.0, 0.0, 0.0],
                                                       [0.0, 0.0, 0.0],
                                                       [0.0, 0.0, 0.0]],

        matrix_mul_zero_right: ([[1.0, 2.0, 3.0],
                                 [4.0, 5.0, 6.0],
                                 [7.0, 8.0, 9.0]],
                                [[0.0, 0.0, 0.0],
                                 [0.0, 0.0, 0.0],
                                 [0.0, 0.0, 0.0]]) -> [[0.0, 0.0, 0.0],
                                                        [0.0, 0.0, 0.0],
                                                        [0.0, 0.0, 0.0]],

        matrix_mul_diagonal_scale_right: ([[1.0, 2.0, 3.0],
                                           [4.0, 5.0, 6.0],
                                           [7.0, 8.0, 9.0]],
                                          [[2.0, 0.0, 0.0],
                                           [0.0, 3.0, 0.0],
                                           [0.0, 0.0, 4.0]]) -> [[2.0, 6.0, 12.0],
                                                                  [8.0, 15.0, 24.0],
                                                                  [14.0, 24.0, 36.0]],

        matrix_mul_diagonal_scale_left: ([[2.0, 0.0, 0.0],
                                          [0.0, 3.0, 0.0],
                                          [0.0, 0.0, 4.0]],
                                         [[1.0, 2.0, 3.0],
                                          [4.0, 5.0, 6.0],
                                          [7.0, 8.0, 9.0]]) -> [[2.0, 4.0, 6.0],
                                                                 [12.0, 15.0, 18.0],
                                                                 [28.0, 32.0, 36.0]],

        matrix_mul_permutation_swap_rows_left: ([[0.0, 1.0, 0.0],
                                                 [1.0, 0.0, 0.0],
                                                 [0.0, 0.0, 1.0]],
                                                [[1.0, 2.0, 3.0],
                                                 [4.0, 5.0, 6.0],
                                                 [7.0, 8.0, 9.0]]) -> [[4.0, 5.0, 6.0],
                                                                         [1.0, 2.0, 3.0],
                                                                         [7.0, 8.0, 9.0]],

        matrix_mul_permutation_swap_cols_right: ([[1.0, 2.0, 3.0],
                                                  [4.0, 5.0, 6.0],
                                                  [7.0, 8.0, 9.0]],
                                                 [[0.0, 1.0, 0.0],
                                                  [1.0, 0.0, 0.0],
                                                  [0.0, 0.0, 1.0]]) -> [[2.0, 1.0, 3.0],
                                                                          [5.0, 4.0, 6.0],
                                                                          [8.0, 7.0, 9.0]],

        matrix_mul_general_small_ints: ([[1.0, 2.0, 3.0],
                                         [4.0, 5.0, 6.0],
                                         [7.0, 8.0, 9.0]],
                                        [[9.0, 8.0, 7.0],
                                         [6.0, 5.0, 4.0],
                                         [3.0, 2.0, 1.0]]) -> [[30.0, 24.0, 18.0],
                                                                [84.0, 69.0, 54.0],
                                                                [138.0, 114.0, 90.0]],

        matrix_mul_general_with_negatives: ([[2.0, -1.0, 3.0],
                                             [0.0, 4.0, -2.0],
                                             [5.0, 1.0, 1.0]],
                                            [[-1.0, 2.0, 0.0],
                                             [3.0, -4.0, 1.0],
                                             [2.0, 1.0, -3.0]]) -> [[1.0, 11.0, -10.0],
                                                                     [8.0, -18.0, 10.0],
                                                                     [0.0, 7.0, -2.0]],

        matrix_mul_upper_triangular: ([[1.0, 2.0, 3.0],
                                       [0.0, 4.0, 5.0],
                                       [0.0, 0.0, 6.0]],
                                      [[7.0, 8.0, 9.0],
                                       [0.0, 10.0, 11.0],
                                       [0.0, 0.0, 12.0]]) -> [[7.0, 28.0, 67.0],
                                                               [0.0, 40.0, 104.0],
                                                               [0.0, 0.0, 72.0]],

        matrix_mul_sparse_pattern: ([[0.0, 2.0, 0.0],
                                     [0.0, 0.0, 3.0],
                                     [4.0, 0.0, 0.0]],
                                    [[5.0, 0.0, 6.0],
                                     [0.0, 7.0, 0.0],
                                     [8.0, 0.0, 9.0]]) -> [[0.0, 14.0, 0.0],
                                                            [24.0, 0.0, 27.0],
                                                            [20.0, 0.0, 24.0]],

        matrix_mul_fractional_exact: ([[0.5, 0.25, 0.125],
                                       [0.0, 0.5, 0.25],
                                       [0.25, 0.0, 0.5]],
                                      [[2.0, 0.0, 4.0],
                                       [1.0, 2.0, 0.0],
                                       [0.0, 8.0, 2.0]]) -> [[1.25, 1.5, 2.25],
                                                              [0.5, 3.0, 0.5],
                                                              [0.5, 4.0, 2.0]],

        matrix_mul_associativity_witness_ab: ([[1.0, 2.0, 0.0],
                                               [0.0, 1.0, 3.0],
                                               [4.0, 0.0, 1.0]],
                                              [[2.0, 0.0, 1.0],
                                               [1.0, 3.0, 0.0],
                                               [0.0, 2.0, 4.0]]) -> [[4.0, 6.0, 1.0],
                                                                      [1.0, 9.0, 12.0],
                                                                      [8.0, 2.0, 8.0]],

        matrix_mul_associativity_witness_bc: ([[2.0, 0.0, 1.0],
                                               [1.0, 3.0, 0.0],
                                               [0.0, 2.0, 4.0]],
                                              [[1.0, 0.0, 2.0],
                                               [0.0, 1.0, 0.0],
                                               [3.0, 0.0, 1.0]]) -> [[5.0, 0.0, 5.0],
                                                                      [1.0, 3.0, 2.0],
                                                                      [12.0, 2.0, 4.0]],
    ];
}
