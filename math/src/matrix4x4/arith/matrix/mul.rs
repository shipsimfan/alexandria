use crate::Matrix4x4;
use std::{
    marker::Destruct,
    ops::{Add, Mul, MulAssign},
};

impl<T: [const] Add<Output = T> + [const] Mul<Output = T> + [const] Clone + [const] Destruct> const
    Mul for Matrix4x4<T>
{
    type Output = Matrix4x4<T>;

    fn mul(self, rhs: Self) -> Self::Output {
        Matrix4x4::new_rows(
            self.r0 * rhs.clone(),
            self.r1 * rhs.clone(),
            self.r2 * rhs.clone(),
            self.r3 * rhs,
        )
    }
}

impl<T: [const] Add<Output = T> + [const] Mul<Output = T> + [const] Clone + [const] Destruct> const
    MulAssign for Matrix4x4<T>
{
    fn mul_assign(&mut self, rhs: Self) {
        *self = self.clone() * rhs;
    }
}

#[cfg(test)]
mod tests {
    use crate::Matrix4x4f;

    macro_rules! matrix_mul_tests {
        [$(
            $test_name: ident: ($i1: expr, $i2: expr) -> $o: expr,
        )*] => {$(
            #[test]
            fn $test_name() {
                const INPUT1: Matrix4x4f = Matrix4x4f::from_row_array($i1);
                const INPUT2: Matrix4x4f = Matrix4x4f::from_row_array($i2);
                const OUTPUT: Matrix4x4f = Matrix4x4f::from_row_array($o);

                let output = INPUT1 * INPUT2;

                assert!(output.approx_eq(OUTPUT, 1e-6), "matrix multiply failed: {} vs. {}", output, OUTPUT);
            }
        )*};
    }

    matrix_mul_tests![
        matrix_mul_identity_left: (
            [[1.0, 0.0, 0.0, 0.0],
             [0.0, 1.0, 0.0, 0.0],
             [0.0, 0.0, 1.0, 0.0],
             [0.0, 0.0, 0.0, 1.0]],
            [[1.0, 2.0, 3.0, 4.0],
             [5.0, 6.0, 7.0, 8.0],
             [9.0, 10.0, 11.0, 12.0],
             [13.0, 14.0, 15.0, 16.0]]
        ) -> [[1.0, 2.0, 3.0, 4.0],
              [5.0, 6.0, 7.0, 8.0],
              [9.0, 10.0, 11.0, 12.0],
              [13.0, 14.0, 15.0, 16.0]],

        matrix_mul_identity_right: (
            [[2.0, 0.0, 1.0, 3.0],
             [4.0, 1.0, 0.0, 2.0],
             [0.0, 5.0, 2.0, 1.0],
             [1.0, 0.0, 0.0, 1.0]],
            [[1.0, 0.0, 0.0, 0.0],
             [0.0, 1.0, 0.0, 0.0],
             [0.0, 0.0, 1.0, 0.0],
             [0.0, 0.0, 0.0, 1.0]]
        ) -> [[2.0, 0.0, 1.0, 3.0],
              [4.0, 1.0, 0.0, 2.0],
              [0.0, 5.0, 2.0, 1.0],
              [1.0, 0.0, 0.0, 1.0]],

        matrix_mul_zero_left: (
            [[0.0, 0.0, 0.0, 0.0],
             [0.0, 0.0, 0.0, 0.0],
             [0.0, 0.0, 0.0, 0.0],
             [0.0, 0.0, 0.0, 0.0]],
            [[1.0, 2.0, 3.0, 4.0],
             [5.0, 6.0, 7.0, 8.0],
             [9.0, 10.0, 11.0, 12.0],
             [13.0, 14.0, 15.0, 16.0]]
        ) -> [[0.0, 0.0, 0.0, 0.0],
              [0.0, 0.0, 0.0, 0.0],
              [0.0, 0.0, 0.0, 0.0],
              [0.0, 0.0, 0.0, 0.0]],

        matrix_mul_zero_right: (
            [[2.0, 0.0, 1.0, 3.0],
             [4.0, 1.0, 0.0, 2.0],
             [0.0, 5.0, 2.0, 1.0],
             [1.0, 0.0, 0.0, 1.0]],
            [[0.0, 0.0, 0.0, 0.0],
             [0.0, 0.0, 0.0, 0.0],
             [0.0, 0.0, 0.0, 0.0],
             [0.0, 0.0, 0.0, 0.0]]
        ) -> [[0.0, 0.0, 0.0, 0.0],
              [0.0, 0.0, 0.0, 0.0],
              [0.0, 0.0, 0.0, 0.0],
              [0.0, 0.0, 0.0, 0.0]],

        matrix_mul_diagonal_times_diagonal: (
            [[2.0, 0.0, 0.0, 0.0],
             [0.0, 3.0, 0.0, 0.0],
             [0.0, 0.0, 4.0, 0.0],
             [0.0, 0.0, 0.0, 5.0]],
            [[10.0, 0.0, 0.0, 0.0],
             [0.0, 20.0, 0.0, 0.0],
             [0.0, 0.0, 30.0, 0.0],
             [0.0, 0.0, 0.0, 40.0]]
        ) -> [[20.0, 0.0, 0.0, 0.0],
              [0.0, 60.0, 0.0, 0.0],
              [0.0, 0.0, 120.0, 0.0],
              [0.0, 0.0, 0.0, 200.0]],

        matrix_mul_translation_compose_column_last: (
            [[1.0, 0.0, 0.0, 1.0],
             [0.0, 1.0, 0.0, 2.0],
             [0.0, 0.0, 1.0, 3.0],
             [0.0, 0.0, 0.0, 1.0]],
            [[1.0, 0.0, 0.0, 4.0],
             [0.0, 1.0, 0.0, 5.0],
             [0.0, 0.0, 1.0, 6.0],
             [0.0, 0.0, 0.0, 1.0]]
        ) -> [[1.0, 0.0, 0.0, 5.0],
              [0.0, 1.0, 0.0, 7.0],
              [0.0, 0.0, 1.0, 9.0],
              [0.0, 0.0, 0.0, 1.0]],

        matrix_mul_swap_xy_then_scale: (
            [[0.0, 1.0, 0.0, 0.0],
             [1.0, 0.0, 0.0, 0.0],
             [0.0, 0.0, 1.0, 0.0],
             [0.0, 0.0, 0.0, 1.0]],
            [[2.0, 0.0, 0.0, 0.0],
             [0.0, 3.0, 0.0, 0.0],
             [0.0, 0.0, 4.0, 0.0],
             [0.0, 0.0, 0.0, 1.0]]
        ) -> [[0.0, 3.0, 0.0, 0.0],
              [2.0, 0.0, 0.0, 0.0],
              [0.0, 0.0, 4.0, 0.0],
              [0.0, 0.0, 0.0, 1.0]],

        matrix_mul_general_integers_1: (
            [[1.0, 2.0, 3.0, 4.0],
             [0.0, 1.0, 0.0, 1.0],
             [5.0, 6.0, 7.0, 8.0],
             [1.0, 0.0, 0.0, 1.0]],
            [[2.0, 0.0, 1.0, 0.0],
             [3.0, 0.0, 0.0, 1.0],
             [4.0, 1.0, 0.0, 0.0],
             [0.0, 2.0, 3.0, 1.0]]
        ) -> [[20.0, 11.0, 13.0, 6.0],
              [3.0, 2.0, 3.0, 2.0],
              [56.0, 23.0, 29.0, 14.0],
              [2.0, 2.0, 4.0, 1.0]],

        matrix_mul_upper_triangular_mix: (
            [[1.0, 1.0, 1.0, 1.0],
             [0.0, 1.0, 1.0, 1.0],
             [0.0, 0.0, 1.0, 1.0],
             [0.0, 0.0, 0.0, 1.0]],
            [[1.0, 2.0, 0.0, 0.0],
             [0.0, 1.0, 2.0, 0.0],
             [0.0, 0.0, 1.0, 2.0],
             [0.0, 0.0, 0.0, 1.0]]
        ) -> [[1.0, 3.0, 3.0, 3.0],
              [0.0, 1.0, 3.0, 3.0],
              [0.0, 0.0, 1.0, 3.0],
              [0.0, 0.0, 0.0, 1.0]],

        matrix_mul_left_diagonal_scales_rows: (
            [[0.5, 0.0, 0.0, 0.0],
             [0.0, -1.0, 0.0, 0.0],
             [0.0, 0.0, 2.0, 0.0],
             [0.0, 0.0, 0.0, 1.0]],
            [[1.0, 2.0, 3.0, 4.0],
             [5.0, 6.0, 7.0, 8.0],
             [9.0, 10.0, 11.0, 12.0],
             [13.0, 14.0, 15.0, 16.0]]
        ) -> [[0.5, 1.0, 1.5, 2.0],
              [-5.0, -6.0, -7.0, -8.0],
              [18.0, 20.0, 22.0, 24.0],
              [13.0, 14.0, 15.0, 16.0]],
    ];
}
